<script src="http://massistant.ddns.net:3000/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>    
    var socket = io('http://massistant.ddns.net:3000');
</script>
<script>

    // Opciones del menú global
    const globalMenu = [
        { name: "Página principal", url: "http://massistant.ddns.net/moodle/my/", type: "home" },
        { name: "Asignaturas", url: undefined, type: "course" },
        { name: "Mensajes", url: `http://massistant.ddns.net/moodle/message/index.php`, type: "message" },
        { name: "Calificaciones", url: `http://massistant.ddns.net/moodle/grade/report/overview/index.php`, type: "clasification" },
        { name: "Desplegar menú", url: undefined, type: "menu_toggle" },
        { name: "Presentación", url: undefined, type: "config" },
        { name: "Sobre MA", url: undefined, type: "about" }
    ]
    // Opciones del submenú de la asignatura
    const courseMenu = [
        { name: "Abrir" },
        { name: "Buscar" },
        { name: "Navegar" },
        { name: "Calificaciones" },
        { name: "Profesores" },
        { name: "Menú global" }
    ]

    // Menú seleccionado (globalMenu por defecto)
    var menuOnUse = globalMenu;
    // Última vez clicado
    var lastClick;
    // ¿Está en input?
    var isOnInput = false;
    // Puntero
    var pointerMenu = -1;
    // Menu items
    var menuItems;
    // Se ejecuta cuando el cliente pierde la conexión con el sistema
    socket.on('disconnect', (reason) => {
        setTimeout(() => {
            $(".massistant").css("background", "linear-gradient(14deg, rgba(184, 15, 15, 0.6) 0%, rgba(219, 66, 31, 0.6) 50%, rgba(232, 122, 44, 0.6) 100%)");
            showMessage("Se ha perdido la conexión con el servidor. Clica abajo para intentar restablecer la conexión.")
        }, 2500);
    });

    // Se ejecuta cuando el cliente se conecta de forma correcta con el sistema
    socket.on('connect', (reason) => {
        // Cambiar a color de conectado
        $(".massistant").css("background", "linear-gradient(14deg, rgba(15, 184, 173, 0.6) 0%, rgba(31, 200, 219, 0.6) 50%, rgba(44, 181, 232, 0.6) 100%)");
        $("#massistant_popup").css("visibility", "visible");
        // Mostrar el menú
        showMenu(globalMenu);
    });

    // Se ejecuta cuando el cliente se reconecta con el sistema de forma correcta
    socket.on('reconnect', (attemtNumber) => {
        $(".massistant").css("background", "linear-gradient(14deg, rgba(15, 184, 173, 0.6) 0%, rgba(31, 200, 219, 0.6) 50%, rgba(44, 181, 232, 0.6) 100%)");
        showMessage("Se ha reestablecido la conexión correctamente.");
    })

    // Función para mostrar en forma de menú todas las opciones
    function showMenu(data) {
        var htmlRepresentation = "";
        data.forEach((value, index) => {
            htmlRepresentation += `<div class="massistant_menu_option massistant_menu_option_${value.type}">${value.name}<\/div>`;
        });
        $("#massistant_menu_content").html(htmlRepresentation);
        $("#massistant_menu").css({ "visibility": "visible" });

        // Asignamos el valor a la "lista"
        menuItems = $("#massistant_menu div.massistant_menu_option");

        if (localStorage.getItem("visibleMass")) {
            $('#massistant').css({ "opacity": "1", "visibility": "visible" });
            $("#massistant_popup").css({ "display": "block" });
            if (localStorage.getItem("lastMenuItemSelected")) {
                pointerMenu = parseInt(localStorage.getItem("lastMenuItemSelected"));
                $(menuItems[pointerMenu]).css("color", "#21b8d1").css("font-size", "20px");
                localStorage.removeItem("lastMenuItemSelected");
            }
        }

    }

    function doubleClickMA() {
        if ($('#massistant_popup').css('display') === "none") {
            localStorage.setItem("visibleMass", true);
            $('#massistant').css({ "opacity": "1", "visibility": "visible" });
            $('#massistant > div').css({ "visibility": "" });
            $('#massistant_popup').css({ "display": "block" });
            showMenu(globalMenu);
        }
        else {
            $('#massistant').css({ "opacity": "", "visibility": "" });
            $('#massistant_popup').css({ "display": "none" });
            localStorage.removeItem("visibleMass");
        }
    }

    // Se ejecuta cuando se realiza click en el ícono
    function onclickma() {
        // ¿Es doble click?
        let newClick = Date.now();
        console.log(`new click = ${newClick} and last click = ${lastClick}`)
        if (socket.connected && !socket.disconnected && lastClick != undefined && newClick - lastClick < 200) {
            doubleClickMA();
        }
        // Forzar reconexión
        else if (socket.disconnected) {
            socket.open();
            setTimeout(() => {
                if (socket.connected)
                    showMessage("Se ha reestablecido la conexión correctamente.");
            }, 200);
        }
        lastClick = Date.now();
    };

    // Muestra un mensaje con el HTML que se le asigne en "message" y que desaparece en un intervalo específicado "timeout"
    function showMessage(message, timeout) {
        $("#massistant_message").css("visibility", "visible");
        $("#massistant_message_content").empty().append(`<p id="massistant_menu_msg">${message}<\/p>`);
        setTimeout(() => {
            hideMessage();
        }, timeout || 10000);
    }

    // Oculta el mensaje, se ejecuta cuando se pulsa la "x"
    function hideMessage() {
        $("#massistant_message").css("visibility", "");
        $("#massistant_message_content").empty();
    }

    // Oculta el menú, se ejecuta cuando se pulsa la "x"
    function hideMenu() {
        $("#massistant_menu").css("visibility", "");
        $("#massistant_menu_content").empty();
    }

    // Opciones cargadas cuando el DOM se encuentra totalmente cargado
    $('document').ready(() => {

        $('#massistant_icon').click(onclickma);

        $('input').focusin(() => {
            isOnInput = true;
        });

        $('input').focusout(() => {
            isOnInput = false;
        });

        // Ejecutado únicamente cuando se levanta el dedo de la tecla
        $('body').keyup((event) => {
            if (!isOnInput && socket.connected && !socket.disconnected) {
                switch (event.keyCode) {
                    // m
                    case 77:
                        doubleClickMA();
                        break;
                    // Left
                    case 37:
                        break;
                    // Right
                    case 39:
                        if ($("#massistant").css("opacity") === "1") {
                            event.preventDefault();
                            getInTheItemOption();
                        }
                        break;
                }
            }
        });

        // Ejecutado mientras siga el dedo presionando la tecla
        $('body').keydown((event) => {
            console.log(event.keyCode);
            if (!isOnInput && socket.connected && !socket.disconnected) {
                switch (event.keyCode) {
                    // Up
                    case 38:
                        if ($("#massistant").css("opacity") === "1") {
                            event.preventDefault();
                            goUpInTheMenu();
                        }
                        break;
                    // Down
                    case 40:
                        if ($("#massistant").css("opacity") === "1") {
                            event.preventDefault();
                            goDownInTheMenu();
                        }
                        break;
                }
            }
        });
    });

    function goUpInTheMenu() {
        // Asignamos valor
        if (pointerMenu != 0 && pointerMenu != -1)
            pointerMenu = (pointerMenu - 1) % menuItems.length;
        else
            pointerMenu = menuItems.length - 1;
        // Si tiene valores que no son iniciales
        if (pointerMenu !== menuItems.length - 1)
            $(menuItems[pointerMenu + 1]).css("color", "").css("font-size", "");
        else
            $(menuItems[0]).css("color", "").css("font-size", "");
        $(menuItems[pointerMenu]).css("color", "#21b8d1").css("font-size", "20px");
    }

    function goDownInTheMenu() {
        // Asignamos valor
        pointerMenu = (pointerMenu + 1) % menuItems.length;
        $(menuItems[pointerMenu]).css("color", "#21b8d1").css("font-size", "20px");

        // Si tiene valores que no son iniciales
        if (pointerMenu != -1 && pointerMenu != 0) {
            $(menuItems[pointerMenu - 1]).css("color", "").css("font-size", "");
        } else {
            $(menuItems[menuItems.length - 1]).css("color", "").css("font-size", "");
        }
    }

    function getInTheItemOption() {
        if (pointerMenu != -1) {
            if (globalMenu[pointerMenu].url) {
                window.location.replace(globalMenu[pointerMenu].url);
                localStorage.setItem("lastMenuItemSelected", pointerMenu);
            }
            else if (!globalMenu[pointerMenu].url) {
                switch (globalMenu[pointerMenu].type) {
                    case "course":
                        showMessage("¿Qué asignatura quieres visitar?", 6000000);
                        break;
                    case "about":
                        showMessage("Soy <i>MAssistant (Moodle Assistant)<\/i>, pretendo ayudarte a utilizar Moodle de una forma más sencilla e intuitiva como alumno.<br\/>Desarrollado por <strong>Francis Santos<\/strong> como proyecto de fin de carrera en el segundo periodo del curso 2017/2018.", 15000)
                        break;
                    default:
                        showMessage("Esta opción no está disponible en estos momentos.");
                        break;
                }
            }
        }
    }
</script>
<style>
    p#massistant_menu_msg {
        margin: 20px 10px 0px 10px;
        text-align: center;
    }

    div.massistant {
        cursor: pointer;
        position: fixed;
        height: 70px;
        width: 70px;
        background: linear-gradient(14deg, rgba(188, 186, 186, 0.6) 0%, rgba(78, 78, 78, 0.6) 50%, rgba(218, 218, 218, 0.6) 100%) repeat scroll 0% 0%;
        margin: -115px 12px 12px 0px;
        right: 0;
        text-align: center;
        line-height: 70px;
        font-size: 30px;
        border: 0px solid transparent;
        border-radius: 100px;
        bottom: 0;
    }

    div#massistant {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        opacity: 0.3;
    }

    div#massistant:hover {
        opacity: 1;
    }

    div#massistant_popup {
        position: fixed;
        margin: auto 12px 82px 0px;
        right: 0;
        bottom: 0;
        visibility: hidden;
        display: none;
    }

    div.massistant_box {
        max-height: 350px;
        max-width: 300px;
        background: #f5f5f5;
        box-shadow: 0px 0px 10px #AAA;
        border-radius: 6px;
        visibility: hidden;
        padding: 5px;
        margin-bottom: 10px;
        margin-left: 10px;
        position: relative;
    }

    div.massistant_popupbox_close_btn {
        position: absolute;
        height: 20px;
        width: 20px;
        margin-right: 5px;
        line-height: 20px;
        text-align: center;
        font-size: 20px;
        cursor: pointer;
        font-family: calibri;
        right: 0;
    }

    .massistant_menu_option {
        text-align: left;
        margin-bottom: 10px;
        font-size: 18px;
        word-break: inherit;
        line-height: 20px;
        padding-left: 35px;
    }

    .massistant_popupbox_content {
        margin: 15px;
        cursor: context-menu;
    }

    .massistant_menu_option_course {
        background: url(https://image.flaticon.com/icons/svg/103/103340.svg) no-repeat;
        background-size: 20px;
    }

    .massistant_menu_option_message {
        background: url(https://image.flaticon.com/icons/svg/126/126516.svg) no-repeat;
        background-size: 20px;
    }

    .massistant_menu_option_clasification {
        background: url(https://image.flaticon.com/icons/svg/782/782702.svg) no-repeat;
        background-size: 20px;
    }

    .massistant_menu_option_about {
        background: url(https://image.flaticon.com/icons/svg/685/685815.svg) no-repeat;
        background-size: 20px;
    }

    .massistant_menu_option_menu_toggle {
        background: url(https://image.flaticon.com/icons/svg/109/109682.svg) no-repeat;
        background-size: 20px;
    }

    .massistant_menu_option_config {
        background: url(https://image.flaticon.com/icons/svg/70/70367.svg) no-repeat;
        background-size: 20px;
    }

    .massistant_menu_option_home {
        background: url(https://image.flaticon.com/icons/svg/263/263115.svg) no-repeat;
        background-size: 20px;
    }

    @media screen and (max-height: 559px) and (min-width: 600px) {
        div.massistant_box {
            display: inline-block;
        }
    }

    @media screen and (max-width: 600px) {
        div#massistant {
            display: none;
        }
    }
</style>